<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¢…ëª© ë°œêµ´</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
  <style>
    /* ì˜¤ë¥¸ìª½ ìˆ¨ê²¨ì§„ ì‚¬ì´ë“œë°” */
    #watchlist-bar {
      position: fixed;
      top: 50px;
      right: -15%; /* ì²˜ìŒì—” ìˆ¨ì–´ ìˆìŒ */
      width: 20%;
      height: 35%;
      background-color: #f8f9fa;
      border: 1px solid #ccc;
      border-right: none;
      padding: 15px;
      transition: right 0.3s ease;
      z-index: 1000;
    }

    #watchlist-bar:hover {
      right: 0; /* hover ì‹œ ë‚˜íƒ€ë‚¨ */
    }

    #basketlist-bar {
      position: fixed;
      top: 500px;
      right: -15%; /* ì²˜ìŒì—” ìˆ¨ê¹€ ìƒíƒœ */
      width: 20%;
      height: 35%;
      background-color: #f8f9fa;
      border: 1px solid #ccc;
      border-right: none;
      padding: 15px;
      transition: right 0.3s ease;
      z-index: 999;
    }

    #basketlist-bar:hover {
      right: 0; /* hover ì‹œ ë‚˜íƒ€ë‚¨ */
    }

    .compact-wrapper {
      position: relative;
    }

    .compact-wrapper:hover .full-hover-list {
      display: block;
    }

    .full-hover-list:not(:hover) {
      display: none;
    }

    .full-hover-list {
      position: absolute;
      left: -505px;
      top: 0;
      width: 500px;
      max-height: 260%;
      overflow-y: auto;
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      z-index: 9999;
      white-space: normal;
      word-wrap: break-word;
      word-break: break-all;
    }

    .stock-code {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .stock-code span {
      cursor: pointer;
      color: red;
    }

    .mt-5 {
      margin-left: 0;
    }
  </style>
</head>
<body class="p-5 bg-light">
  <button class="btn btn-primary" onclick="location.href='/'">ë‚´ í˜„í™© í™ˆ</button>
  <button class="btn btn-primary" onclick="location.href='/index3'">íˆ¬ì ë‚ ì”¨</button>
  <button class="btn btn-primary" onclick="location.href='/index4'">ë‰´ìŠ¤</button>
  <button class="btn btn-primary" onclick="location.href='/index2'">ì¢…ëª© ë°œêµ´</button>
  <button class="btn btn-primary" onclick="location.href='/index5'">ğŸ” ë°ì´í„°</button>

  <div class="container">
    <div id="output-holdings" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
  </div>

  <button class="btn btn-sm btn-outline-primary w-20 mt-2" onclick="getTradinghistory()">ë§¤ë§¤ê¸°ë¡ ì¡°íšŒ</button>
  <br/><button class="btn btn-sm btn-outline-primary w-20 mt-2" onclick="downloadTradinghistory()">ë§¤ë§¤ê¸°ë¡ CSV ë‹¤ìš´ë¡œë“œ</button>
  <br/>ë§¤ë§¤ê¸°ë¡ CSV ì—…ë¡œë“œ
  <input type="file" id="csv-history-upload" class="form-control form-control-sm mt-2" accept=".csv" onchange="uploadTradinghistory(event)">

  <div style="margin-top: 30px;">
    <label for="stockSearch">ì¢…ëª©ëª… ê²€ìƒ‰: </label>
    <input type="text" id="stockSearch" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì" onkeyup="searchStock()" />
    <div id="searchResults" style="border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none;"></div>
  </div>

  <br/><br/><br/><br/><br/><br/>
  <div class="container mt-5">
      <h2 class="mb-4">ğŸ“ˆ ê±°ë˜ëŸ‰ ìƒìœ„ 50ì¢…ëª©</h2>
      <button class="btn btn-success" onclick="fetchVolumeLeaders()">ì¡°íšŒí•˜ê¸°</button>
      <div id="output-volume" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
  </div>

  <br/><br/>
  <div class="container mt-5">
      <h2 class="mb-4">ê³¨ë“ í¬ë¡œìŠ¤(ì˜ˆìƒ) ì¢…ëª© ì¡°íšŒ</h2>&nbsp;&nbsp;&nbsp;<span>â€» 5ì¼ì„ , 20ì¼ì„  ëª¨ë‘ ë‹¨ê¸°ì´í‰ì„ ì— í•´ë‹¹í•˜ë‚˜, ì—¬ê¸°ì„œëŠ” 5ì¼ì„ ì„ ê¸°ì¤€ìœ¼ë¡œ ëŒíŒŒìƒíƒœë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.</span>
      <br/><br/><button class="btn btn-success" onclick="checkGoldenCross()">ì¡°íšŒí•˜ê¸°</button>
  </div>

  <br/><br/>
  <div class="container mt-5">
      <h2 class="mb-4">ë°ë“œí¬ë¡œìŠ¤(ì˜ˆìƒ) ì¢…ëª© ì¡°íšŒ (BASKET)</h2>&nbsp;&nbsp;&nbsp;<span>â€» 5ì¼ì„ , 20ì¼ì„  ëª¨ë‘ ë‹¨ê¸°ì´í‰ì„ ì— í•´ë‹¹í•˜ë‚˜, ì—¬ê¸°ì„œëŠ” 5ì¼ì„ ì„ ê¸°ì¤€ìœ¼ë¡œ (í•˜í–¥)ëŒíŒŒìƒíƒœë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.</span>
      <br/><br/><button class="btn btn-success" onclick="checkDeadCross()">ì¡°íšŒí•˜ê¸°</button>
  </div>

  <br/><br/>
  <div class="container mt-5">
      <h2 class="mb-4">RSI ì¡°íšŒ</h2>
      <input type="hidden" id="rsiCode" value="" />
      <input type="text" id="stockRsiSearch" value="" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì" onkeyup="searchRsiStock()" />&nbsp;&nbsp;&nbsp;<span>â€» ì…ë ¥ í›„ ì—”í„°</span>
      <div id="searchRsiResults" style="border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none;"></div>
      <div id="pickRsiResult" style="border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none;"></div>
      <br><br>
      <button class="btn btn-success" onclick="getRsiData()">ì‹¤ì‹œê°„ RSI ì¡°íšŒí•˜ê¸° (BASKET ëª©ë¡)</button>
  </div>

  <br/><br/>
  <div class="container mt-5">
      <h2 class="mb-4">MACD ì¡°íšŒ</h2>
      <input type="hidden" id="macdCode" value="" />
      <input type="text" id="stockMacdSearch" value="" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì" onkeyup="searchMacdStock()" />&nbsp;&nbsp;&nbsp;<span>â€» ì…ë ¥ í›„ ì—”í„°</span>
      <div id="searchMacdResults" style="border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none;"></div>
      <div id="pickMacdResult" style="border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none;"></div>
      <br><br>
      <button class="btn btn-success" onclick="getMacdData()">ì‹¤ì‹œê°„ MACD ì¡°íšŒí•˜ê¸° (BASKET ëª©ë¡)</button>
  </div>

  <br/><br/>
  <div class="container mt-5">
      <h2 class="mb-4">Slow STC ì¡°íšŒ (Slow STC : 20 ~ 30 ì‚¬ì´, %D ëŒíŒŒ && MACD ì‹œê·¸ë„ ëŒíŒŒ)</h2>
      <input type="text" id="stockStochasticSearch" value="" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì" onkeyup="searchStochasticStock()" />&nbsp;&nbsp;&nbsp;<span>â€» ì…ë ¥ í›„ ì—”í„°</span>
      <div id="searchStochasticResults" style="border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none;"></div>
      <div id="pickStochasticResult" style="border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none;"></div>
      <br><br>
      <button class="btn btn-success" onclick="getStochasticData()">ì¡°íšŒí•˜ê¸° (BASKET ëª©ë¡)</button>
  </div>

  <br/><br/>
  <div class="container mt-5">
      <h2 class="mb-4">Slow STC í†µí•© ì¡°íšŒ (MACD, RSI, Slow STC ëª¨ë‘ ì¶©ì¡± ì¡°ê±´)</h2>&nbsp;&nbsp;&nbsp;<span style="font-size: 80%; color:red;">â€» RSI, MACD ì¡°íšŒ ì™„ë£Œ í›„ í´ë¦­í•  ê²ƒ</span>
      <div id="searchRsiMacdStochasticResults" style="border: 1px solid #ccc; max-height: 200px; overflow-y: auto; display: none;"></div>
      <br><br>
      <button class="btn btn-success" onclick="getRsiMacdStochasticData()">ì¡°íšŒí•˜ê¸° (BASKET ëª©ë¡)</button>
  </div>

  <br/><br/>
  <div class="container mt-5">
    <h2 class="mb-4">BASKET ì¢…ëª© ê¸ˆì¼ ê±°ë˜ëŸ‰ ì €ì¥</h2>
    <div id="result_volume_insert" class="border p-2 mb-2 rounded"></div>
    <button class="btn btn-success" onclick="saveVolumeData()">ì €ì¥í•˜ê¸°</button>
  </div>

  <br/><br/>
  <div class="container mt-5">
    <h2 class="mb-4">ê¸‰ë“± ê±°ë˜ëŸ‰ íƒì§€</h2>
    <button id="checkVolume" class="btn btn-success" onclick="checkVolume()">ì‹œì‘</button>
    <span id="volumeStatus" class="ms-3">ê¸‰ë“± ê±°ë˜ëŸ‰ íƒì§€ ì •ì§€</span>

    <div id="volumelist-display" class="mt-3"></div>
  </div>

  <!-- ë§¤ë§¤ê¸°ë¡ ëª¨ë‹¬ -->
  <div class="modal fade" id="myTradinghistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ë§¤ë§¤ê¸°ë¡ ì¡°íšŒ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <div id="output-myTradinghistory" class="card p-3 mt-3 shadow-sm"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
      </div>
    </div>
  </div>

  <!-- ê³¨ë“ í¬ë¡œìŠ¤ ê²°ê³¼ ëª¨ë‹¬ -->
  <div class="modal fade" id="goldenCrossModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ê³¨ë“ í¬ë¡œìŠ¤(ì˜ˆìƒ) ì¢…ëª© ì¡°íšŒ ê²°ê³¼</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <div id="output-goldenCross" class="card p-3 mt-3 shadow-sm"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
      </div>
    </div>
  </div>

  <!-- ë°ë“œí¬ë¡œìŠ¤ ê²°ê³¼ ëª¨ë‹¬ -->
  <div class="modal fade" id="deadCrossModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ë°ë“œí¬ë¡œìŠ¤(ì˜ˆìƒ) ì¢…ëª© ì¡°íšŒ ê²°ê³¼</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <div id="output-deadCross" class="card p-3 mt-3 shadow-sm"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
      </div>
    </div>
  </div>

  <!-- RSI ê²°ê³¼ ëª¨ë‹¬ -->
  <div class="modal fade" id="rsiModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">RSI ì¡°íšŒ ê²°ê³¼</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <div id="output-rsi" class="card p-3 mt-3 shadow-sm"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
      </div>
    </div>
  </div>

  <!-- MACD ê²°ê³¼ ëª¨ë‹¬ -->
  <div class="modal fade" id="macdModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">MACD ì¡°íšŒ ê²°ê³¼</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <div id="output-macd" class="card p-3 mt-3 shadow-sm"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
      </div>
    </div>
  </div>

  <!-- STC ê²°ê³¼ ëª¨ë‹¬ -->
  <div class="modal fade" id="stcModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">STC ì¡°íšŒ ê²°ê³¼</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <div id="output-stc" class="card p-3 mt-3 shadow-sm"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
      </div>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” -->
  <div id="watchlist-bar">
    <h6>ğŸ“Œ ê´€ì‹¬ì¢…ëª© ë“±ë¡</h6>
    <input type="text" class="form-control" id="stock-input" placeholder="ì˜ˆ: A005930">
    <button class="btn btn-sm btn-warning w-100 mt-2" onclick="addStock()">ë“±ë¡</button>
    <div id="watchlist-display" class="mt-3"></div>
    <button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="downloadWatchlist()">CSV ë‹¤ìš´ë¡œë“œ</button>
    <br><br>
    CSV íŒŒì¼ ì—…ë¡œë“œ
    <br>
    <input type="file" id="csv-upload" class="form-control form-control-sm mt-2" accept=".csv" onchange="uploadWatchlist(event)">
  </div>

  <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°”: BASKET -->
  <div id="basketlist-bar">
    <h6>ğŸ“¦ BASKET ì¢…ëª© ë“±ë¡</h6>
    <input type="text" class="form-control" id="basket-input" placeholder="ì˜ˆ: A005930">
    <button class="btn btn-sm btn-warning w-100 mt-2" onclick="addStock2()">ë“±ë¡</button>
    <div id="basketlist-display" class="mt-3"></div>
    <button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="downloadBasket()">CSV ë‹¤ìš´ë¡œë“œ</button>
    <br><br>
    CSV íŒŒì¼ ì—…ë¡œë“œ
    <br>
    <input type="file" id="csv-basket-upload" class="form-control form-control-sm mt-2" accept=".csv" onchange="uploadBasket(event)">
  </div>

  <!-- ë§¤ìˆ˜ ëª¨ë‹¬ -->
  <div class="modal fade" id="buyModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ğŸ“¥ ì¢…ëª© ë§¤ìˆ˜</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p id="buyStockInfo"></p>
            <input type="hidden" id="buyCode">
            <input type="hidden" id="buyName">
            <div class="mb-3">
                <label>ë§¤ìˆ˜ ê°€ê²©</label>
                <input type="number" id="buyPrice" class="form-control">
            </div>
            <div class="mb-3">
                <label>ë§¤ìˆ˜ ìˆ˜ëŸ‰</label>
                <input type="number" id="buyQty" class="form-control">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="submitBuyOrder()">ë§¤ìˆ˜</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
      </div>
    </div>
  </div>
    
  <!-- ë§¤ë„ ëª¨ë‹¬ -->
  <div class="modal fade" id="sellModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ğŸ“¤ ì¢…ëª© ë§¤ë„</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p id="sellStockInfo"></p>
            <input type="hidden" id="sellCode">
            <input type="hidden" id="sellName">
            <div class="mb-3">
                <label>ë§¤ë„ ê°€ê²©</label>
                <input type="number" id="sellPrice" class="form-control">
            </div>
            <div class="mb-3">
                <label>ë§¤ë„ ìˆ˜ëŸ‰</label>
                <input type="number" id="sellQty" class="form-control">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-danger" onclick="submitSellOrder()">ë§¤ë„</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
      </div>
    </div>
  </div>

  <script>
    let myModalInstance;

    let myHoldings = [];
    const STORAGE_KEY = "watchlist";
    const STORAGE_KEY_2 = "basketlist";
    const STORAGE_KEY_3 = "tradinghistory";
    const STORAGE_KEY_4 = "volumelist";
    
    let myTradinghistory_date = [];
    let myTradinghistory_code = [];
    let myTradinghistory_price = [];
    let myTradinghistory_qty = [];
    let myTradinghistory_flag = [];
    setTradinghistory();

    // ê±°ë˜ëŸ‰ ê¸‰ë“± ì¢…ëª© ë¶ˆëŸ¬ì˜¤ê¸°
    function loadVolumelist() {
      const saved = localStorage.getItem(STORAGE_KEY_4);
      return saved ? JSON.parse(saved) : [];
    }

    // ê´€ì‹¬ì¢…ëª© ë¶ˆëŸ¬ì˜¤ê¸°
    function loadWatchlist() {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    }

    // ê´€ì‹¬ì¢…ëª© ì €ì¥
    function saveWatchlist(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    // ê´€ì‹¬ì¢…ëª© UI ì¶œë ¥
    function renderWatchlist() {
      const list = loadWatchlist();
      const display = document.getElementById("watchlist-display");
      display.innerHTML = "";

      const wrapper = document.createElement("div");
      wrapper.className = "compact-wrapper";
      const visible = document.createElement("div");
      visible.className = "compact-list" + (list.length > 3 ? " hovered" : "");

      list.slice(0, 3).forEach(code => {
        const row = document.createElement("div");
        row.className = "d-flex justify-content-between";

        const label = document.createElement("span");
        label.textContent = code;

        row.appendChild(label);
        visible.appendChild(row);
      });

      if (list.length > 3) {
        const dots = document.createElement("div");
        dots.textContent = "...";
        visible.appendChild(dots);
      }

      const full = document.createElement("div");
      full.className = "full-hover-list";

      list.forEach(code => {
        const row = document.createElement("div");
        row.className = "d-flex justify-content-between";

        const label = document.createElement("span");
        label.textContent = code;

        const btn = document.createElement("button");
        btn.textContent = "ì‚­ì œ";
        btn.className = "btn btn-sm btn-outline-danger ms-2";
        btn.onclick = () => removeStock(code);

        row.appendChild(label);
        row.appendChild(btn);
        full.appendChild(row);
      });

      wrapper.appendChild(visible);
      wrapper.appendChild(full);
      display.appendChild(wrapper);
    }

    // ì¢…ëª© ì¶”ê°€
    function addStock() {
      const input = document.getElementById("stock-input");
      const code = input.value.trim().toUpperCase();
      if (!code) return;
      let list = loadWatchlist();
      if (!list.includes(code)) {
        list.push(code);
        saveWatchlist(list);
        renderWatchlist();
        input.value = "";
      }
    }

    // ì¢…ëª© ì‚­ì œ
    function removeStock(code) {
      let list = loadWatchlist();
      list = list.filter(c => c !== code);
      saveWatchlist(list);
      renderWatchlist();
    }

    function downloadWatchlist() {
      const list = loadWatchlist();
      if (!list.length) {
        alert("ê´€ì‹¬ì¢…ëª©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      const csv = list.join(",");
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // ğŸ”‘ UTF-8 BOM

      const blob = new Blob([bom, csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "watchlist.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function uploadWatchlist(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;
        const codes = content.split(",").map(c => c.trim().toUpperCase()).filter(Boolean);

        if (codes.length === 0) {
        alert("íŒŒì¼ì— ì¢…ëª© ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
        }

        const uniqueCodes = Array.from(new Set(codes));
        saveWatchlist(uniqueCodes);
        renderWatchlist();
        alert("ê´€ì‹¬ ì¢…ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!");
      };
      reader.readAsText(file);
    }

    function searchStock() {
        const keyword = document.getElementById("stockSearch").value;
        if (!keyword.trim()) {
          document.getElementById("searchResults").style.display = "none";
          document.getElementById("searchResults").innerHTML = "";
          return;
        }

        if (window.event.keyCode == 13) {

          fetch("/api/search-stock", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ keyword })
          })
          .then(response => response.json())
          .then(data => {
            const resultDiv = document.getElementById("searchResults");
            resultDiv.innerHTML = "";

            if (data.length === 0) {
                resultDiv.style.display = "none";
                return;
            }

            data.forEach(item => {
              const div = document.createElement("div");
              div.className = "d-flex justify-content-between align-items-center";
              div.style.padding = "5px";

              const label = document.createElement("span");
              label.textContent = `${item.name} (${item.code})`;

              const btnGroup = document.createElement("div");
              btnGroup.className = "d-flex gap-1";

              const btn = document.createElement("button");
              btn.className = "btn btn-sm btn-outline-success";
              btn.textContent = "ê´€ì‹¬ ë“±ë¡";
              btn.onclick = () => {
                document.getElementById("stock-input").value = item.name + "[" + item.code + "]";
                addStock();
              };

              const btn2 = document.createElement("button");
              btn2.className = "btn btn-sm btn-outline-success";
              btn2.textContent = "BASKET ë“±ë¡";
              btn2.onclick = () => {
                document.getElementById("basket-input").value = item.name + "[" + item.code + "]";
                addStock2();
              };

              btnGroup.appendChild(btn);
              btnGroup.appendChild(btn2);

              div.appendChild(label);
              div.appendChild(btnGroup);
              resultDiv.appendChild(div);
            });

            resultDiv.style.display = "block";
          });
      }
    }

    function loadBasket() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY_2) || "[]");
    }
    
    function saveBasket(list) {
      localStorage.setItem(STORAGE_KEY_2, JSON.stringify(list));
    }

    function renderBasket() {
      const list = loadBasket();
      const display = document.getElementById("basketlist-display");
      display.innerHTML = "";

      const wrapper = document.createElement("div");
      wrapper.className = "compact-wrapper";
      const visible = document.createElement("div");
      visible.className = "compact-list" + (list.length > 3 ? " hovered" : "");

      list.slice(0, 3).forEach(code => {
        const row = document.createElement("div");
        row.className = "d-flex justify-content-between";

        const label = document.createElement("span");
        label.textContent = code;

        row.appendChild(label);
        visible.appendChild(row);
      });

      if (list.length > 3) {
        const dots = document.createElement("div");
        dots.textContent = "...";
        visible.appendChild(dots);
      }

      const full = document.createElement("div");
      full.className = "full-hover-list";

      list.forEach(code => {
        const row = document.createElement("div");
        row.className = "d-flex justify-content-between";

        const label = document.createElement("span");
        label.textContent = code;

        const btn = document.createElement("button");
        btn.textContent = "ì‚­ì œ";
        btn.className = "btn btn-sm btn-outline-danger ms-2";
        btn.onclick = () => removeBasket(code);

        row.appendChild(label);
        row.appendChild(btn);
        full.appendChild(row);
      });

      wrapper.appendChild(visible);
      wrapper.appendChild(full);
      display.appendChild(wrapper);
    }

    function addStock2() {
      const input = document.getElementById("basket-input");
      const code = input.value.trim().toUpperCase();
      if (!code) return;
      let list = loadBasket();
      if (!list.includes(code)) {
        list.push(code);
        saveBasket(list);
        renderBasket();
        input.value = "";
      }
    }

    function removeBasket(code) {
      let list = loadBasket();
      list = list.filter(item => item !== code);
      saveBasket(list);
      renderBasket();
    }

    function downloadBasket() {
      const list = loadBasket();
      if (!list.length) {
            alert("BASKET ì¢…ëª©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

      const csv = list.join(",");
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // ğŸ”‘ UTF-8 BOM

      const blob = new Blob([bom, csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "basketlist.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function uploadBasket(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result.trim();
        const codes = content.split(",").map(c => c.trim().toUpperCase()).filter(Boolean);

        if (codes.length === 0) {
            alert("íŒŒì¼ì— ì¢…ëª© ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const uniqueCodes = Array.from(new Set(codes));
        saveBasket(uniqueCodes);
        renderBasket();
        alert("BASKET ì¢…ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!");
      };
      reader.readAsText(file);
    }

    // ë§¤ë§¤ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function tradinghistory() {
      const saved = localStorage.getItem(STORAGE_KEY_3);
      return saved ? JSON.parse(saved) : [];
    }

    // ë§¤ë§¤ê¸°ë¡ ì €ì¥
    function saveTradinghistory(list) {
      localStorage.setItem(STORAGE_KEY_3, JSON.stringify(list));
    }

    // ë§¤ë§¤ê¸°ë¡ ì¶”ê°€
    function addTradinghistory(code, name, price, qty, flag) {
      let today = new Date();   

      let year = today.getFullYear();             // ë…„ë„: 2024
      let month = (today.getMonth() + 1).toString().padStart(2, '0');  // ì›”: 01 ~ 12
      let date = today.getDate().toString().padStart(2, '0');          // ì¼: 01 ~ 31

      // let tradingDate = year + '-' + month + '-' + date;
      let tradingDate = `${year}${month}${date}`;   // ìµœì¢… ê²°ê³¼: "20240722"

      let param = tradingDate + '_' + name + '['+code+']_' + (price).toString() + '_' + (qty).toString()  + '_' + flag

      let list = tradinghistory();
      list.push(param);
      saveTradinghistory(list);
    }

    function downloadTradinghistory() {
      const list = tradinghistory();
      if (!list.length) {
        alert("ë§¤ë§¤ê¸°ë¡ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      const csv = list.join(",");
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // ğŸ”‘ UTF-8 BOM

      const blob = new Blob([bom, csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "tradinghistory.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function uploadTradinghistory(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;
        const codes = content
          .split(",")
          .map(c => c.trim())
          .filter(Boolean);

        if (codes.length === 0) {
          alert("íŒŒì¼ì— ë§¤ë§¤ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const uniqueCodes = Array.from(new Set(codes));
        saveTradinghistory(uniqueCodes);
        alert("ë§¤ë§¤ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!");
      };

      // âœ… ì¸ì½”ë”© ëª…ì‹œ (ì¼ë°˜ì ìœ¼ë¡œ UTF-8)
      reader.readAsText(file, 'utf-8');
    }

    // ë§¤ë§¤ê¸°ë¡ ì‚­ì œ
    function removeHistory(index) {
      console.log("removeHistory");
      console.log("index : "+index);

      let list = tradinghistory();
      const deletedIndex = index;
      list.splice(deletedIndex, 1);

      saveTradinghistory(list);
      getTradinghistory();
    }

    function setTradinghistory() {
      myTradinghistory_date = [];
      myTradinghistory_code = [];
      myTradinghistory_price = [];
      myTradinghistory_qty = [];
      myTradinghistory_flag = [];

      const list = tradinghistory();
      
      list.forEach(trade => {
        let tradeArr = trade.split("_");
        myTradinghistory_date.push(tradeArr[0]);
        
        const str = tradeArr[1];
        const lastBracketIndex = str.lastIndexOf("[");
        const code = str.substring(lastBracketIndex + 1, str.length - 1);
        myTradinghistory_code.push(code);

        myTradinghistory_price.push(tradeArr[2]);
        myTradinghistory_qty.push(tradeArr[3]);
        myTradinghistory_flag.push(tradeArr[4]);
      });

      console.log("myTradinghistory_date : "+myTradinghistory_date);
      console.log("myTradinghistory_code : "+myTradinghistory_code);
      console.log("myTradinghistory_price : "+myTradinghistory_price);
      console.log("myTradinghistory_qty : "+myTradinghistory_qty);
      console.log("myTradinghistory_flag : "+myTradinghistory_flag);
    }


    function getTradinghistory() {
      const list = tradinghistory();
      const container = document.getElementById("output-myTradinghistory");
      container.innerHTML = "<p>ë§¤ë§¤ê¸°ë¡ ì¡°íšŒ ì¤‘...</p>";

      if (!myModalInstance) {
        myModalInstance = new bootstrap.Modal(document.getElementById("myTradinghistoryModal"));
      }
      myModalInstance.show();

      if (!list.length) {
        container.innerHTML = "<p class='text-muted'>ğŸ“­ ë§¤ë§¤ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      // í…Œì´ë¸” ì‹œì‘
      let html = `
        <table class="table table-bordered table-striped table-sm">
          <thead class="table-light">
            <tr>
              <th>No</th>
              <th>ë‚ ì§œ</th>
              <th>ì¢…ëª©ëª…</th>
              <th>ì¢…ëª©ì½”ë“œ</th>
              <th>ë§¤ë§¤ê°€ê²©</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>êµ¬ë¶„</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
      `;

      list.forEach((trade, index) => {
        let tradeArr = trade.split("_");
        const date = tradeArr[0];

        const str = tradeArr[1];
        const lastBracketIndex = str.lastIndexOf("[");
        const code = str.substring(lastBracketIndex + 1, str.length - 1);
        const nm = str.substring(0, lastBracketIndex);

        const price = tradeArr[2];
        const qty = tradeArr[3];
        const flag = tradeArr[4] === "buy" ? "ë§¤ìˆ˜" : "ë§¤ë„";

        html += `
          <tr>
            <td>${index + 1}</td>
            <td>${date}</td>
            <td>${nm}</td>
            <td>${code}</td>
            <td>${Number(price).toLocaleString()} ì›</td>
            <td>${qty} ì£¼</td>
            <td>${flag}</td>
            <td><button class="btn btn-sm btn-outline-danger ms-2" onclick="removeHistory(${index})">ì‚­ì œ</button></td>
          </tr>
        `;
      });

      html += "</tbody></table>";
      container.innerHTML = html;

      setTradinghistory();
    }

    async function fetchHoldings() {
      const el = document.getElementById("output-holdings");

      try {
          const res = await fetch("/api/holdings");
          const data = await res.json();

          myHoldings = []; // ì „ì—­ ë°°ì—´ ì´ˆê¸°í™”

          if (data.error) {
              return;
          }

          if (Array.isArray(data) && data.length > 0) {
              let list = data.map(h => {
                  const tmpCode = h.code.replace("A", "");
                  myHoldings.push(tmpCode); // ë³´ìœ  ì¢…ëª© ì €ì¥
              });
          }
      } catch (err) {
          return;
      }
    }

    async function fetchVolumeLeaders() {
      const el = document.getElementById("output-volume");
      el.innerHTML = "<p>ğŸ“¡ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤...</p>";
      el.style.display = "block";

      try {
          // âœ… ë¨¼ì € holdings ë¡œë”© ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¼
          await fetchHoldings();

          // âœ… ê·¸ ë‹¤ìŒ volume ë°ì´í„° fetch
          const res = await fetch("/api/volume-leaders");
          const data = await res.json();

          if (data.error) {
              el.innerHTML = `<p class="text-danger">âŒ ${data.error}</p>`;
              return;
          }

          let html = `
              <table class="table table-striped">
                  <thead>
                      <tr>
                          <th>ì¢…ëª©ì½”ë“œ</th>
                          <th>ì¢…ëª©ëª…</th>
                          <th>í˜„ì¬ê°€</th>
                          <th>ê±°ë˜ëŸ‰</th>
                          <th>ê±°ë˜ê¸ˆì•¡</th>
                          <th></th>
                          <th></th>
                      </tr>
                  </thead>
                  <tbody>`;

          data.stocks.forEach(stock => {
              const isOwned = myHoldings.includes(stock.code);
              if (isOwned) {
                  console.log("âœ… ë³´ìœ  ì¢…ëª© ë§¤ì¹­:", stock.code, stock.name);
              }

              html += `
                  <tr>
                      <td>${stock.code}</td>
                      <td>${stock.name}</td>
                      <td>${Math.abs(Number(stock.price)).toLocaleString()} ì›</td>
                      <td>${Number(stock.vol).toLocaleString()} ì£¼</td>
                      <td>${Number(stock.amount).toLocaleString()} (ë°±ë§Œ)ì›</td>
                      <td>
                          <button class="btn btn-sm btn-outline-primary buy-btn"
                                  data-code="${stock.code}"
                                  data-name="${stock.name}"
                                  data-price="${Math.abs(stock.price)}">
                              êµ¬ë§¤
                          </button>
                          ${isOwned ? `
                          <button class="btn btn-sm btn-outline-danger ms-2 sell-btn"
                                  data-code="${stock.code}"
                                  data-name="${stock.name}"
                                  data-price="${Math.abs(stock.price)}">
                              ë§¤ë„
                          </button>` : ""}
                      </td>
                      <td>
                          <button class="btn btn-sm btn-outline-success"
                                  onclick='do_for_addStock("${stock.name}", "${stock.code}")'>
                              ê´€ì‹¬ ë“±ë¡
                          </button>
                          <button class="btn btn-sm btn-outline-success"
                                  onclick='do_for_addBasket("${stock.name}", "${stock.code}")'>
                              BASKET ë“±ë¡
                          </button>
                      </td>
                  </tr>`;
          });

          html += `</tbody></table>`;
          el.innerHTML = html;
        } catch (err) {
            console.error("ğŸ“› fetchVolumeLeaders ì—ëŸ¬:", err);
            el.innerHTML = `<p class="text-danger">âŒ ì˜¤ë¥˜ ë°œìƒ: ${err}</p>`;
        }
    }

    async function checkGoldenCross() {
      const basket = loadBasket(); // ì˜ˆ: ["ì‚¼ì„±ì „ì[005930]", "ì¹´ì¹´ì˜¤[035720]"]
      const resultDiv = document.getElementById("output-goldenCross");
      resultDiv.innerHTML = "<p>ğŸ“¡ ê³¨ë“ í¬ë¡œìŠ¤ ë¶„ì„ ì¤‘...</p>";
      // resultDiv.style.display = "block";
      const modal = new bootstrap.Modal(document.getElementById("goldenCrossModal"));
      modal.show();

      resultDiv.innerHTML = ""; // ê²°ê³¼ ì´ˆê¸°í™”

      // âœ… ë¨¼ì € holdings ë¡œë”© ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¼
      await fetchHoldings();

      for (const item of basket) {
        const str = item;
        const lastBracketIndex = str.lastIndexOf("[");
        const code = str.substring(lastBracketIndex + 1, str.length - 1);
        console.log("code : " + code);

        try {
          let history_date = [];
          let history_code = [];
          let history_price = [];
          let history_qty = [];
          let history_flag = [];

          if(myTradinghistory_code.length > 0){
            myTradinghistory_code.forEach( (historyCode, index) => {
              if(historyCode === code){
                history_date.push(myTradinghistory_date[index]);
                history_code.push(myTradinghistory_code[index]);
                history_price.push(myTradinghistory_price[index]);
                history_qty.push(myTradinghistory_qty[index]);
                history_flag.push(myTradinghistory_flag[index]);
              }
            });
          }

          const res = await fetch('/detect-golden-cross', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ "code": code })
          });
          const data = await res.json();

          //----------------------- ê³¨ë“ í¬ë¡œìŠ¤ ë°œìƒ(ëŒ€ë¹„) ì¢…ëª©ë§Œ ì¶œë ¥ ------------------
          if (data.golden_cross === "Y") {
          //----------------------- ê³¨ë“ í¬ë¡œìŠ¤ ë°œìƒ(ëŒ€ë¹„) ì¢…ëª©ë§Œ ì¶œë ¥ ------------------

            console.log("âœ… ê³¨ë“ í¬ë¡œìŠ¤ ê²°ê³¼:", data);

            // âœ… ë¨¼ì € holdings ë¡œë”© ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¼
            // await fetchHoldings();

            const isOwned = myHoldings.includes(code);

            const buttons = document.createElement("div");
            buttons.innerHTML = `
              <button class="btn btn-sm btn-outline-primary buy-btn"
                  data-code="${data.code}"
                  data-name="${data.name}"
                  data-price="${Math.abs(data.price)}">
                êµ¬ë§¤
              </button>
              ${isOwned ? `
              <button class="btn btn-sm btn-outline-danger ms-2 sell-btn"
                  data-code="${data.code}"
                  data-name="${data.name}"
                  data-price="${Math.abs(data.price)}">
                ë§¤ë„
              </button>` : ""}
            `;

            const box = document.createElement("div");
            box.className = "border p-2 mb-2 rounded";

            const title = document.createElement("strong");
            title.textContent = item;

            const result = document.createElement("div");
            if (data.golden_cross === "Y") {
              result.innerHTML = `<span class="text-success">âœ” ê³¨ë“ í¬ë¡œìŠ¤ ${data.comment2 || ""}</span>`;
            } else {
              result.innerHTML = `<span class="text-muted">âœ– ì¡°ê±´ ë¯¸ì¶©ì¡±</span>`;
            }
            result.innerHTML += `<br><span class="text-muted">${data.comment || ""}</span><br><button class="btn btn-success" onclick="getMovingAverage('${code}','${history_date}','${history_code}','${history_price}','${history_qty}','${history_flag}')">ì´ë™í‰ê· ì„  í™•ì¸</button>`;

            if (data.reason) {
              const reason = document.createElement("div");
              reason.className = "text-danger small";
              reason.textContent = "ğŸ“Œ " + data.reason;
              box.appendChild(reason);
            }

            box.appendChild(title);
            box.appendChild(result);
            box.appendChild(buttons);
            resultDiv.appendChild(box);

          //----------------------- ê³¨ë“ í¬ë¡œìŠ¤ ë°œìƒ(ëŒ€ë¹„) ì¢…ëª©ë§Œ ì¶œë ¥ ------------------
          }
          //----------------------- ê³¨ë“ í¬ë¡œìŠ¤ ë°œìƒ(ëŒ€ë¹„) ì¢…ëª©ë§Œ ì¶œë ¥ ------------------

        } catch (err) {
          const errorBox = document.createElement("div");
          errorBox.className = "border p-2 mb-2 text-danger";
          errorBox.innerHTML = `<strong>${item}</strong> â†’ ì˜¤ë¥˜ ë°œìƒ: ${err}`;
          resultDiv.appendChild(errorBox);
        }
      }

      alert("ê³¨ë“ í¬ë¡œìŠ¤ ì¡°íšŒê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    async function checkDeadCross() {
      const basket = loadBasket(); // ì˜ˆ: ["ì‚¼ì„±ì „ì[005930]", "ì¹´ì¹´ì˜¤[035720]"]
      const resultDiv = document.getElementById("output-deadCross");
      resultDiv.innerHTML = "<p>ğŸ“¡ ë°ë“œí¬ë¡œìŠ¤ ë¶„ì„ ì¤‘...</p>";
      // resultDiv.style.display = "block";
      const modal = new bootstrap.Modal(document.getElementById("deadCrossModal"));
      modal.show();

      resultDiv.innerHTML = ""; // ê²°ê³¼ ì´ˆê¸°í™”

      for (const item of basket) {
        const str = item;
        const lastBracketIndex = str.lastIndexOf("[");
        const code = str.substring(lastBracketIndex + 1, str.length - 1);
        console.log("code : " + code);

        try {
          const res = await fetch('/detect-dead-cross', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ "code": code })
          });
          const data = await res.json();

          if (data.dead_cross === "Y") {

            console.log("âœ… ë°ë“œí¬ë¡œìŠ¤ ê²°ê³¼:", data);

            // âœ… ë¨¼ì € holdings ë¡œë”© ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¼
            await fetchHoldings();

            const isOwned = myHoldings.includes(code);

            const buttons = document.createElement("div");
            buttons.innerHTML = `
              <button class="btn btn-sm btn-outline-primary buy-btn"
                  data-code="${data.code}"
                  data-name="${data.name}"
                  data-price="${Math.abs(data.price)}">
                êµ¬ë§¤
              </button>
              ${isOwned ? `
              <button class="btn btn-sm btn-outline-danger ms-2 sell-btn"
                  data-code="${data.code}"
                  data-name="${data.name}"
                  data-price="${Math.abs(data.price)}">
                ë§¤ë„
              </button>` : ""}
            `;

            const box = document.createElement("div");
            box.className = "border p-2 mb-2 rounded";

            const title = document.createElement("strong");
            title.textContent = item;

            const result = document.createElement("div");
            if (data.dead_cross === "Y") {
              result.innerHTML = `<span class="text-success">âœ” ë°ë“œí¬ë¡œìŠ¤ ${data.comment2 || ""}</span>`;
            } else {
              result.innerHTML = `<span class="text-muted">âœ– ì¡°ê±´ ë¯¸ì¶©ì¡±</span>`;
            }
            result.innerHTML += `<br><span class="text-muted">${data.comment || ""}</span><br><button class="btn btn-success" onclick="getMovingAverage('${code}')">ì´ë™í‰ê· ì„  í™•ì¸</button>`;

            if (data.reason) {
              const reason = document.createElement("div");
              reason.className = "text-danger small";
              reason.textContent = "ğŸ“Œ " + data.reason;
              box.appendChild(reason);
            }

            box.appendChild(title);
            box.appendChild(result);
            box.appendChild(buttons);
            resultDiv.appendChild(box);

          }

        } catch (err) {
          const errorBox = document.createElement("div");
          errorBox.className = "border p-2 mb-2 text-danger";
          errorBox.innerHTML = `<strong>${item}</strong> â†’ ì˜¤ë¥˜ ë°œìƒ: ${err}`;
          resultDiv.appendChild(errorBox);
        }
      }

      alert("ë°ë“œí¬ë¡œìŠ¤ ì¡°íšŒê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function getMovingAverage(code, history_date, history_code, history_price, history_qty, history_flag) {
      fetch('/get-moving-average', {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ 
          "code": code,
          "history_date": history_date,
          "history_code": history_code,
          "history_price": history_price,
          "history_qty": history_qty,
          "history_flag": history_flag
        })
      })
      .then(res => res.json())
      .then(data => {
        console.log("data : "+data)
      });
    }

    function searchRsiStock() {
      const keyword = document.getElementById("stockRsiSearch").value;
        if (!keyword.trim()) {
          document.getElementById("searchRsiResults").style.display = "none";
          document.getElementById("searchRsiResults").innerHTML = "";
          return;
        }

        if (window.event.keyCode == 13) {
          fetch("/api/search-stock", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ keyword })
          })
          .then(response => response.json())
          .then(data => {
            const resultDiv = document.getElementById("searchRsiResults");
            resultDiv.innerHTML = "";

            if (data.length === 0) {
                resultDiv.style.display = "none";
                return;
            }

            data.forEach(item => {
              const div = document.createElement("div");
              div.className = "d-flex justify-content-between align-items-center";
              div.style.padding = "5px";
              
              const label = document.createElement("span");
              label.textContent = `${item.name} (${item.code})`;
              label.id = 'pickRsiCode';
              label.style.cursor = 'pointer';
              label.addEventListener("click", () => getRsiDataByPick(item.code));
              
              div.appendChild(label);
              resultDiv.appendChild(div);     
            });

            resultDiv.style.display = "block";
          });
        }
    }

    async function getRsiDataByPick(code) {
      document.getElementById("searchRsiResults").style.display = "none";
      document.getElementById("searchRsiResults").innerHTML = "";

      const resultDiv = document.getElementById("pickRsiResult");
      resultDiv.style.display = "block";
      resultDiv.innerHTML = "<p>ğŸ“¡ RSI ë¶„ì„ ì¤‘...</p>";

      // âœ… ë¨¼ì € holdings ë¡œë”© ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¼
      // await fetchHoldings();
        
      try {
        const res = await fetch("/get-rsi-data", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ "rsiCode": code })
        });

        const data = await res.json();

        resultDiv.innerHTML = '';
        if (data === null || data === undefined) {
          resultDiv.style.display = "none";
          return;
        }

        let resultLog = `rsi : ${data.rsi}` + `\navg_gain : ${data.avg_gain}` + `\navg_loss : ${data.avg_loss}`;
        console.log(resultLog);

        resultDiv.className = "border p-2 mb-2 rounded";
        resultDiv.innerHTML = `<span class="text-success">âœ” RSI : ${data.rsi}</span>&nbsp;&nbsp;&nbsp;<b id="close_rsi" style="cursor:pointer">X</b>`;
      } catch (err) {
        resultDiv.className = "border p-2 mb-2 text-danger";
        resultDiv.innerHTML = `<strong>${item}</strong> â†’ ì˜¤ë¥˜ ë°œìƒ: ${err}`;
      }
    }

    async function getRsiData() {
      const basket = loadBasket();
      const resultDiv = document.getElementById("output-rsi");
      resultDiv.innerHTML = "<p>ğŸ“¡ RSI ë¶„ì„ ì¤‘...</p>";

      const modal = new bootstrap.Modal(document.getElementById("rsiModal"));
      modal.show();

      resultDiv.innerHTML = ""; // ê²°ê³¼ ì´ˆê¸°í™”

      // âœ… ë¨¼ì € holdings ë¡œë”© ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¼
      // await fetchHoldings();

      for (const item of basket) {
        const str = item;
        const lastBracketIndex = str.lastIndexOf("[");
        const code = str.substring(lastBracketIndex + 1, str.length - 1);
        console.log("code : " + code);  
        
        try {
          const res = await fetch("/get-rsi-data", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ "rsiCode": code })
          });

          const data = await res.json();
          let resultLog = `rsi : ${data.rsi}` + `\navg_gain : ${data.avg_gain}` + `\navg_loss : ${data.avg_loss}`;
          console.log(resultLog);

          const box = document.createElement("div");
          box.className = "border p-2 mb-2 rounded";

          const title = document.createElement("strong");
          title.textContent = item;

          const result = document.createElement("div");
          result.innerHTML = `<span class="text-success">âœ” RSI : ${data.rsi}</span>`;

          box.appendChild(title);
          box.appendChild(result);
          resultDiv.appendChild(box);
        } catch (err) {
          const errorBox = document.createElement("div");
          errorBox.className = "border p-2 mb-2 text-danger";
          errorBox.innerHTML = `<strong>${item}</strong> â†’ ì˜¤ë¥˜ ë°œìƒ: ${err}`;
          resultDiv.appendChild(errorBox);
        }
      }

      alert("RSI ì¡°íšŒê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function searchMacdStock() {
      const keyword = document.getElementById("stockMacdSearch").value;
        if (!keyword.trim()) {
          document.getElementById("searchMacdResults").style.display = "none";
          document.getElementById("searchMacdResults").innerHTML = "";
          return;
        }

        if (window.event.keyCode == 13) {
          fetch("/api/search-stock", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ keyword })
          })
          .then(response => response.json())
          .then(data => {
            const resultDiv = document.getElementById("searchMacdResults");
            resultDiv.innerHTML = "";

            if (data.length === 0) {
                resultDiv.style.display = "none";
                return;
            }

            data.forEach(item => {
              const div = document.createElement("div");
              div.className = "d-flex justify-content-between align-items-center";
              div.style.padding = "5px";
              
              const label = document.createElement("span");
              label.textContent = `${item.name} (${item.code})`;
              label.id = 'pickMacdCode';
              label.style.cursor = 'pointer';
              label.addEventListener("click", () => getMacdDataByPick(item.code));
              
              div.appendChild(label);
              resultDiv.appendChild(div);     
            });

            resultDiv.style.display = "block";
          });
        }
    }

    async function getMacdDataByPick(code) {
      const searchMacdResult = document.getElementById("searchMacdResults");
      searchMacdResult.innerHTML = '';
      searchMacdResult.display = 'none';

      const res = await fetch("/api/macd", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: code })
      });
      const data = await res.json();
      console.log("MACD ê²°ê³¼:", data);

      const resultDiv = document.getElementById("pickMacdResult");
      resultDiv.style.display = "block";
      resultDiv.className = "border p-2 mb-2 rounded";
      resultDiv.innerHTML = `<span class="text-success">âœ” MACD</span><b id="close_macd" style="cursor:pointer; margin-left:10%;">X</b>
        <br/><span>macd : ${data.macd}</span>
        <br/><span>signal : ${data.signal}</span>
        <br/><span>histogram : ${data.histogram}</span>`;
    }

    async function getMacdData() {
      const basket = loadBasket();
      const resultDiv = document.getElementById("output-macd");
      resultDiv.innerHTML = "<p>ğŸ“¡ MACD ë¶„ì„ ì¤‘...</p>";

      const modal = new bootstrap.Modal(document.getElementById("macdModal"));
      modal.show();

      resultDiv.innerHTML = ""; // ê²°ê³¼ ì´ˆê¸°í™”

      // âœ… ë¨¼ì € holdings ë¡œë”© ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¼
      // await fetchHoldings();

      for (const item of basket) {
        const str = item;
        const lastBracketIndex = str.lastIndexOf("[");
        const code = str.substring(lastBracketIndex + 1, str.length - 1);
        console.log("code : " + code);  

        try {
          const res = await fetch("/api/macd", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
          });

          const data = await res.json();
          console.log("MACD ê²°ê³¼:", data);

          const box = document.createElement("div");
          box.className = "border p-2 mb-2 rounded";

          const title = document.createElement("strong");
          title.textContent = item;
          
          const result = document.createElement("div");
          result.innerHTML = `<span class="text-success">âœ” macd : ${data.macd} | signal : ${data.signal} | histogram : ${data.histogram}</span>`;

          box.appendChild(title);
          box.appendChild(result);
          resultDiv.appendChild(box);
        } catch (err) {
          const errorBox = document.createElement("div");
          errorBox.className = "border p-2 mb-2 text-danger";
          errorBox.innerHTML = `<strong>${item}</strong> â†’ ì˜¤ë¥˜ ë°œìƒ: ${err}`;
          resultDiv.appendChild(errorBox);
        }
      }

      alert("MACD ì¡°íšŒê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    async function searchStochasticStock() {
      const keyword = document.getElementById("stockStochasticSearch").value;
      if (!keyword.trim()) {
        document.getElementById("searchStochasticResults").style.display = "none";
        document.getElementById("searchStochasticResults").innerHTML = "";
        return;
      }

      if (window.event.keyCode == 13) {
          fetch("/api/search-stock", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ keyword })
          })
          .then(response => response.json())
          .then(data => {
            const resultDiv = document.getElementById("searchStochasticResults");
            resultDiv.innerHTML = "";

            if (data.length === 0) {
                resultDiv.style.display = "none";
                return;
            }

            data.forEach(item => {
              const div = document.createElement("div");
              div.className = "d-flex justify-content-between align-items-center";
              div.style.padding = "5px";
              
              const label = document.createElement("span");
              label.textContent = `${item.name} (${item.code})`;
              label.id = 'pickStochasticCode';
              label.style.cursor = 'pointer';
              label.addEventListener("click", () => getStochasticDataByPick(item.code));
              
              div.appendChild(label);
              resultDiv.appendChild(div);     
            });

            resultDiv.style.display = "block";
          });
        }
    }

    async function getStochasticDataByPick(code) {
      const searchStochasticResult = document.getElementById("searchStochasticResults");
      searchStochasticResult.innerHTML = '';
      searchStochasticResult.display = 'none';

      const res = await fetch("/api/stochastic", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: code })
      });
      const data = await res.json();
      console.log("Slow Stochastic ê²°ê³¼:", data);

      const resultDiv = document.getElementById("pickStochasticResult");
      resultDiv.style.display = "block";
      resultDiv.className = "border p-2 mb-2 rounded";

      resultDiv.innerHTML = `<span class="text-success">âœ” Slow Stochastic</span>&nbsp;&nbsp;&nbsp;<b id="close_stc" style="cursor:pointer">X</b>
        <br/><span>%K : ${data.K}</span>
        <br/><span>%D : ${data.D}</span>`;
    }

    async function getStochasticData() {
      const basket = loadBasket();
      const resultDiv = document.getElementById("output-stc");
      resultDiv.innerHTML = "<p>ğŸ“¡ Slow STC ë¶„ì„ ì¤‘...</p>";

      const modal = new bootstrap.Modal(document.getElementById("stcModal"));
      modal.show();

      resultDiv.innerHTML = ""; // ê²°ê³¼ ì´ˆê¸°í™”

      for (const item of basket) {
        const str = item;
        const lastBracketIndex = str.lastIndexOf("[");
        const code = str.substring(lastBracketIndex + 1, str.length - 1);
        console.log("code : " + code);  

        try {
          const res = await fetch("/api/stochastic", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
          });

          const data = await res.json();
          console.log("STC ê²°ê³¼:", data.stc);
          console.log("MACD ê²°ê³¼:", data.macd);

          const box = document.createElement("div");
          box.className = "border p-2 mb-2 rounded";

          const title = document.createElement("strong");
          title.textContent = item;
          
          const result = document.createElement("div");
          result.innerHTML = `<span class="text-success">âœ” %K : ${data.stc.K} | %D : ${data.stc.D}</span>`;

          //------------------- ì¶œë ¥ ì¡°ê±´ ì„¤ì • ---------------------
          let k = Number(data.stc.K);
          let d = Number(data.stc.D);
          let macd = Number(data.macd.macd);
          let signal = Number(data.macd.signal);
          
          if(k > 19 && k < 30 && k >= d && macd >= signal){
            box.appendChild(title);
            box.appendChild(result);
            resultDiv.appendChild(box);
          }          
          //------------------- ì¶œë ¥ ì¡°ê±´ ì„¤ì • ---------------------
        } catch (err) {
          const errorBox = document.createElement("div");
          errorBox.className = "border p-2 mb-2 text-danger";
          errorBox.innerHTML = `<strong>${item}</strong> â†’ ì˜¤ë¥˜ ë°œìƒ: ${err}`;
          resultDiv.appendChild(errorBox);
        }
      }

      alert("Slow STC && MACD ì‹œê·¸ë„ ëŒíŒŒ ì¡°íšŒê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    async function getRsiMacdStochasticData() {
      const basket = loadBasket();
      const resultDiv = document.getElementById("output-stc");
      resultDiv.innerHTML = "<p>ğŸ“¡ ë¶„ì„ ì¤‘...</p>";

      const modal = new bootstrap.Modal(document.getElementById("stcModal"));
      modal.show();

      resultDiv.innerHTML = ""; // ê²°ê³¼ ì´ˆê¸°í™”

      for (const item of basket) {
        const str = item;
        const lastBracketIndex = str.lastIndexOf("[");
        const code = str.substring(lastBracketIndex + 1, str.length - 1);
        console.log("code : " + code);  

        try {
          const res = await fetch("/api/stochastic2", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
          });

          const data = await res.json();
          console.log("STC ê²°ê³¼:", data);

          const box = document.createElement("div");
          box.className = "border p-2 mb-2 rounded";

          const title = document.createElement("strong");
          title.textContent = item;
          
          const result = document.createElement("div");
          result.innerHTML = `<span class="text-success">âœ” %K : ${data.K}, %D : ${data.D} | MACD ì‹œê·¸ë„ ëŒíŒŒ : ${data.macd_break} | RSI 50 ëŒíŒŒ : ${data.rsi_up}</span>`;

          //------------------- ì¶œë ¥ ì¡°ê±´ ì„¤ì • ---------------------
          let k = Number(data.K);
          let d = Number(data.D);
          
          let stc_up = data.stc_up;
          let macd_up = data.macd_up;
          let macd_break = data.macd_break;
          let rsi_up = data.rsi_up;
          
          if(k > 19 && k < 30 && k >= d && stc_up === 'Y' && macd_up === 'Y' && macd_break === 'Y' && rsi_up === 'Y'){
            box.appendChild(title);
            box.appendChild(result);
            resultDiv.appendChild(box);
          }
          //------------------- ì¶œë ¥ ì¡°ê±´ ì„¤ì • ---------------------
        } catch (err) {
          const errorBox = document.createElement("div");
          errorBox.className = "border p-2 mb-2 text-danger";
          errorBox.innerHTML = `<strong>${item}</strong> â†’ ì˜¤ë¥˜ ë°œìƒ: ${err}`;
          resultDiv.appendChild(errorBox);
        }
      }

      alert("[Slow STC, MACD, RSI] í†µí•© ì¡°ê±´ ì¡°íšŒê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    async function saveVolumeData() {
      const basket = loadBasket();
      const resultDiv = document.getElementById("result_volume_insert");
      resultDiv.innerHTML = "<p>ê±°ë˜ëŸ‰ ì €ì¥ ì¤‘...</p>";

      for (const item of basket) {
        const str = item;
        const lastBracketIndex = str.lastIndexOf("[");
        const code = str.substring(lastBracketIndex + 1, str.length - 1);
        console.log("code : " + code);  

        try {
          const res = await fetch('/api/save-volume', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
          });
          const data = await res.json();
          console.log("save-volume ê²°ê³¼:", data);
        } catch (err) {
          const errorBox = document.createElement("div");
          errorBox.className = "border p-2 mb-2 text-danger";
          errorBox.innerHTML = `<strong>${item}</strong> â†’ ì˜¤ë¥˜ ë°œìƒ: ${err}`;
          resultDiv.appendChild(errorBox);
        }
      }
      
      alert("ê±°ë˜ëŸ‰ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      resultDiv.innerHTML = "<p>ê±°ë˜ëŸ‰ ì €ì¥ ì™„ë£Œ</p>";
    }

    async function checkVolume(){
      const basket = loadBasket();
      const resultDiv = document.getElementById("volumeStatus");
      resultDiv.innerHTML = "<p>ê±°ë˜ëŸ‰ ê¸‰ë“± ì¢…ëª© ì¡°íšŒ ì¤‘...</p>";

      for (const item of basket) {
        const str = item;
        const lastBracketIndex = str.lastIndexOf("[");
        const code = str.substring(lastBracketIndex + 1, str.length - 1);
        const name = str.substring(0, lastBracketIndex);
        console.log("code : " + code);
        console.log("name : " + name);

        try {

          const res = await fetch('/api/volume-search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              code: code
              ,name: name
            })
          });
          const data = await res.json();
          console.log(name + "["+code+"] volume-search ê²°ê³¼ : ", data.result);

        } catch (err) {
          const errorBox = document.createElement("div");
          errorBox.className = "border p-2 mb-2 text-danger";
          errorBox.innerHTML = `<strong>${item}</strong> â†’ ì˜¤ë¥˜ ë°œìƒ: ${err}`;
          resultDiv.appendChild(errorBox);
        }
      }

      resultDiv.innerHTML = "<p>ê±°ë˜ëŸ‰ ê¸‰ë“± ì¢…ëª© ì¡°íšŒ ì¢…ë£Œ</p>";
      alert("ê±°ë˜ëŸ‰ ê¸‰ë“± ì¢…ëª© ì¡°íšŒê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    $(document).on("click", "#close_rsi", function(){
      const resultDiv = document.getElementById("pickRsiResult");
      resultDiv.innerHTML = "";
      resultDiv.style.display = "none";
    });

    $(document).on("click", "#close_macd", function(){
      const resultDiv = document.getElementById("pickMacdResult");
      resultDiv.innerHTML = "";
      resultDiv.style.display = "none";
    });

    $(document).on("click", "#close_stc", function(){
      const resultDiv = document.getElementById("pickStochasticResult");
      resultDiv.innerHTML = "";
      resultDiv.style.display = "none";
    });

    function do_for_addStock(name, code){
      document.getElementById("stock-input").value = name + "[" + code + "]";
      addStock();
    }

    function do_for_addBasket(name, code){
      document.getElementById("basket-input").value = name + "[" + code + "]";
      addStock2();
    }

    // Enter í‚¤ ì´ë²¤íŠ¸
    document.getElementById("stock-input").addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        addStock();
      }
    });

    // ìµœì´ˆ ë Œë”ë§
    renderWatchlist();

    // ì´ˆê¸° ë¡œë”© ì‹œ ë Œë”ë§
    window.addEventListener("load", function () {
      renderWatchlist();
      renderBasket();
    });

    function openBuyModal(code, name, price) {
        document.getElementById("buyStockInfo").innerText = `${code} (${name}) í˜„ì¬ê°€: ${Number(price).toLocaleString()} ì›`;
        document.getElementById("buyCode").value = code;
        document.getElementById("buyName").value = name;
        document.getElementById("buyPrice").value = Math.abs(price);
        document.getElementById("buyQty").value = "";
        new bootstrap.Modal(document.getElementById("buyModal")).show();
    }

    function openSellModal(code, name, price) {
        document.getElementById("sellStockInfo").innerText = `${code} (${name}) í˜„ì¬ê°€: ${Number(price).toLocaleString()} ì›`;
        document.getElementById("sellCode").value = code;
        document.getElementById("sellName").value = name;
        document.getElementById("sellPrice").value = Math.abs(price);
        document.getElementById("sellQty").value = "";
        new bootstrap.Modal(document.getElementById("sellModal")).show();
    }

    async function submitBuyOrder() {
        const code = document.getElementById("buyCode").value;
        const name = document.getElementById("buyName").value;
        const price = Math.abs(parseInt(document.getElementById("buyPrice").value));
        const qty = parseInt(document.getElementById("buyQty").value);

        try {
            const res = await fetch("/api/buy", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, price, qty })
            });

            const data = await res.json();

            // âœ… ì—¬ê¸°ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë¨
            addTradinghistory(code, name, price, qty, 'buy');

            alert(data.message || JSON.stringify(data));
            bootstrap.Modal.getInstance(document.getElementById("buyModal")).hide();

        } catch (err) {
            console.error("âŒ ë§¤ìˆ˜ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
            alert("âŒ ë§¤ìˆ˜ ìš”ì²­ ì‹¤íŒ¨: " + err.message);
        }
    }

    async function submitSellOrder() {
        const code = document.getElementById("sellCode").value;
        const name = document.getElementById("sellName").value;
        const price = Math.abs(parseInt(document.getElementById("sellPrice").value));
        const qty = parseInt(document.getElementById("sellQty").value);

        try {
          const res = await fetch("/api/sell", {
              method: "POST",
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code, price, qty })
          });

          const data = await res.json();

          // âœ… ì—¬ê¸°ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë¨
          addTradinghistory(code, name, price, qty, 'sell');

          alert(data.message || JSON.stringify(data));
          bootstrap.Modal.getInstance(document.getElementById("sellModal")).hide();          
        } catch (err) {
          console.error("âŒ ë§¤ìˆ˜ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
          alert("âŒ ë§¤ë„ ìš”ì²­ ì‹¤íŒ¨: " + err.message);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.addEventListener("click", function (e) {
            const buyBtn = e.target.closest(".buy-btn");
            const sellBtn = e.target.closest(".sell-btn");
            if (buyBtn) {
                const code = buyBtn.dataset.code;
                const name = buyBtn.dataset.name;
                const price = buyBtn.dataset.price;
                openBuyModal(code, name, price);
            } else if (sellBtn) {
                const code = sellBtn.dataset.code;
                const name = sellBtn.dataset.name;
                const price = sellBtn.dataset.price;
                openSellModal(code, name, price);
            }
        });
    });

    document.addEventListener('hidden.bs.modal', function () {
      // modal-backdrop ì œê±°
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

      // bodyì— ë‚¨ì•„ìˆëŠ” modal-open í´ë˜ìŠ¤ ì œê±°
      document.body.classList.remove('modal-open');

      // bodyì˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” (ìŠ¤í¬ë¡¤ ë§‰í˜ í•´ì œ ë“±)
      document.body.style = 'p-5 bg-light';
    });
  </script>
</body>
</html>
