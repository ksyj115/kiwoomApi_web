<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í‚¤ì›€ì¦ê¶Œ ì”ê³ ì¡°íšŒ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <!-- Bootstrap JS (í•„ìˆ˜: ëª¨ë‹¬ ê¸°ëŠ¥ í¬í•¨) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-5 bg-light">
    <div class="container">
        <h2 class="mb-4">ğŸ“Š ë‚´ ê³„ì¢Œ ì •ë³´</h2>
        <button class="btn btn-primary" onclick="fetchAccount()">ê³„ì¢Œ ì”ê³  ì¡°íšŒ</button>
        <div id="output" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
        <div id="output-available-cash" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
    </div>
    <br/><br/>
    <div class="container">
        <h2 class="mb-4">ë‚´ ë³´ìœ  ì¢…ëª©</h2>
        <button class="btn btn-primary" onclick="fetchHoldings()">ë³´ìœ  ì¢…ëª© ì¡°íšŒ</button>
        <div id="output" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
        <div id="output-holdings" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
    </div>

    <br/><br/><br/><br/><br/><br/>
    <div class="container mt-5">
        <h2 class="mb-4">ğŸ“ˆ ê±°ë˜ëŸ‰ ìƒìœ„ 50ì¢…ëª©</h2>
        <button class="btn btn-success" onclick="fetchVolumeLeaders()">ì¡°íšŒí•˜ê¸°</button>
        <div id="output-volume" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
    </div>

    <!-- ë§¤ìˆ˜ ëª¨ë‹¬ -->
    <div class="modal fade" id="buyModal" tabindex="-1">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title">ğŸ“¥ ì¢…ëª© ë§¤ìˆ˜</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            <p id="buyStockInfo"></p>
            <input type="hidden" id="buyCode">
            <div class="mb-3">
                <label>ë§¤ìˆ˜ ê°€ê²©</label>
                <input type="number" id="buyPrice" class="form-control">
            </div>
            <div class="mb-3">
                <label>ë§¤ìˆ˜ ìˆ˜ëŸ‰</label>
                <input type="number" id="buyQty" class="form-control">
            </div>
            </div>
            <div class="modal-footer">
            <button class="btn btn-primary" onclick="submitBuyOrder()">ë§¤ìˆ˜</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
        </div>
    </div>
      

    <script>
        function fetchAccount() {
            fetch("/api/account")
                .then(res => res.json())
                .then(data => {
                    const el = document.getElementById("output");
                    if (data.error) {
                        el.innerHTML = `<p class="text-danger">âŒ ${data.error}</p>`;
                    } else {
                        const totalInvestment = Number(data.total_investment.replace(/,/g, ""));
                        const totalValuation = Number(data.total_valuation.replace(/,/g, ""));
                        const profit = totalValuation - totalInvestment;

                        // ìˆ˜ìµ/ì†ì‹¤ ìŠ¤íƒ€ì¼ ë¶„ê¸°
                        const profitClass = profit >= 0 ? "text-danger" : "text-primary";
                        const profitText = profit >= 0 ? `${profit.toLocaleString()} ì›` : `${profit.toLocaleString()} ì›`;

                        // ìˆ˜ìµë¥  ê³„ì‚°
                        let profitRate = 0;
                        if (totalInvestment !== 0) {
                            profitRate = (profit / totalInvestment) * 100;
                        }
                        const profitRateText = `${profitRate.toFixed(2)}%`;

                        el.innerHTML = `
                        <ul class="list-group">
                            <li class="list-group-item"><strong>ì´ íˆ¬ìê¸ˆì•¡:</strong> ${totalInvestment.toLocaleString()} ì›</li>
                            <li class="list-group-item"><strong>ì´ í‰ê°€ê¸ˆì•¡:</strong> ${totalValuation.toLocaleString()} ì›</li>
                            <li class="list-group-item ${profitClass}">
                                <strong>ğŸ“ˆ ì†ìµ:</strong> <span>${profitText}</span>
                                <small class="ms-2">(${profitRateText})</small>
                            </li>
                        </ul>`;
                    }
                    el.style.display = "block";
                });

            fetch("/api/available_cash")
                .then(res => res.json())
                .then(data => {
                    const el = document.getElementById("output-available-cash");
                    if (data.error) {
                        el.innerHTML = `<p class="text-danger">âŒ ${data.error}</p>`;
                    } else {
                        el.innerHTML = `
                            <ul class="list-group">
                                <li class="list-group-item"><strong>ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡:</strong> ${data.available_cash} ì›</li>
                            </ul>`;
                    }
                    el.style.display = "block";
                });
        }

        function fetchHoldings() {
            fetch("/api/holdings")
                .then(res => res.json())
                .then(data => {
                    const el = document.getElementById("output-holdings");
                    if (data.error) {
                        el.innerHTML = `<p class="text-danger">âŒ ${data.error}</p>`;
                    } else if (Array.isArray(data) && data.length > 0) {
                        let list = data.map(h => {
                            const current = Number(h.current_price);
                            const purchase = Number(h.purchase_price);
                            const quantity = Number(h.quantity);
                            const profit = (current - purchase) * quantity;
                            const rate = purchase ? ((current - purchase) / purchase) * 100 : 0;

                            const profitClass = profit >= 0 ? "text-danger" : "text-primary";
                            return `<li class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <span><strong>${h.name}</strong> (${h.code})</span>
                                    <span>${current.toLocaleString()} ì›</span>
                                </div>
                                <div class="d-flex justify-content-between ms-3 mt-1">
                                    <small>- ${purchase.toLocaleString()} ì›</small>
                                    <small>${quantity} ì£¼</small>
                                    <small>${(purchase * quantity).toLocaleString()} ì›</small>
                                    <small class="${profitClass}">${profit.toLocaleString()} ì› (${rate.toFixed(2)}%)</small>
                                </div>
                            </li>`;
                        }).join('');
                        el.innerHTML = `<ul class="list-group">${list}</ul>`;
                    } else {
                        el.innerHTML = "<p>ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                    }
                    el.style.display = "block";
                });
        }

        function fetchVolumeLeaders() {
            fetch("/api/volume-leaders")
                .then(res => res.json())
                .then(data => {
                    const el = document.getElementById("output-volume");
                    if (data.error) {
                        el.innerHTML = `<p class="text-danger">âŒ ${data.error}</p>`;
                    } else {
                        let html = `
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ì¢…ëª©ì½”ë“œ</th>
                                        <th>ì¢…ëª©ëª…</th>
                                        <th>í˜„ì¬ê°€</th>
                                        <th>ê±°ë˜ëŸ‰</th>
                                        <th>ê±°ë˜ê¸ˆì•¡</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>`;
                        data.stocks.forEach(stock => {
                            html += `
                                <tr>
                                    <td>${stock.code}</td>
                                    <td>${stock.name}</td>
                                    <td>${Math.abs(Number(stock.price)).toLocaleString()} ì›</td>
                                    <td>${Number(stock.vol).toLocaleString()} ì£¼</td>
                                    <td>${Number(stock.amount).toLocaleString()} (ë°±ë§Œ)ì›</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary buy-btn"
                                                data-code="${stock.code}"
                                                data-name="${stock.name}"
                                                data-price="${stock.price}">
                                            êµ¬ë§¤
                                        </button>
                                    </td>
                                </tr>`;
                        });

                        html += `</tbody></table>`;
                        el.innerHTML = html;
                    }
                    el.style.display = "block";
                });
        }

        function openBuyModal(code, name, price) {
            document.getElementById("buyStockInfo").innerText = `${code} (${name}) í˜„ì¬ê°€: ${Number(price).toLocaleString()} ì›`;
            document.getElementById("buyCode").value = code;
            document.getElementById("buyPrice").value = price;
            document.getElementById("buyQty").value = "";
            new bootstrap.Modal(document.getElementById("buyModal")).show();
        }


        function submitBuyOrder() {
            const code = document.getElementById("buyCode").value;
            const price = parseInt(document.getElementById("buyPrice").value);
            const qty = parseInt(document.getElementById("buyQty").value);

            fetch("/api/buy", {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ code, price, qty })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message || JSON.stringify(data));
                bootstrap.Modal.getInstance(document.getElementById("buyModal")).hide();
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.addEventListener("click", function (e) {
                const btn = e.target.closest(".buy-btn");
                if (btn) {
                    const code = btn.dataset.code;
                    const name = btn.dataset.name;
                    const price = btn.dataset.price;
                    openBuyModal(code, name, price);
                }
            });
        });
    </script>
</body>
</html>
