<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê³„ì¢Œ, ë³´ìœ  ì¢…ëª© í˜„í™©</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
      #maChart {
        width: 100%;
        max-width: 600px;
        height: 300px;
        margin: auto;
      }
    </style>
</head>
<body class="p-5 bg-light">
    <button class="btn btn-primary" onclick="location.href='/'">ë‚´ í˜„í™© í™ˆ</button>
    <button class="btn btn-primary" onclick="location.href='/index2'">ì¢…ëª© ë°œêµ´</button>
    <br/><br/>

    <div class="container">
        <h2 class="mb-4">ğŸ“Š ë‚´ ê³„ì¢Œ ì •ë³´</h2>
        <button class="btn btn-primary" onclick="fetchAccount()">ê³„ì¢Œ ì”ê³  ì¡°íšŒ</button>
        <div id="output" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
        <div id="output-available-cash" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
    </div>
    <br/><br/>
    <div class="container">
        <h2 class="mb-4">ë‚´ ë³´ìœ  ì¢…ëª©</h2>
        <button class="btn btn-primary" onclick="fetchHoldings()">ë³´ìœ  ì¢…ëª© ì¡°íšŒ</button>
        <div id="output" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
        <div id="output-holdings" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
    </div>
    <br/><br/>
    <div class="container">
        <h2 class="mb-4">ë‚´ ì£¼ë¬¸ ìƒíƒœ</h2>
        <button class="btn btn-primary" onclick="fetchUnfilledOrders()">ë¯¸ì²´ê²° ì£¼ë¬¸ ì¢…ëª© ì¡°íšŒ</button>
        <div id="output" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
        <div id="output-unfilledOrders" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
    </div>

    <br/><br/><br/><br/><br/><br/>
    <div class="container mt-5">
        <h2 class="mb-4">ğŸ“ˆ ê±°ë˜ëŸ‰ ìƒìœ„ 50ì¢…ëª©</h2>
        <button class="btn btn-success" onclick="fetchVolumeLeaders()">ì¡°íšŒí•˜ê¸°</button>
        <div id="output-volume" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
    </div>
    <br/><br/>
    <div class="container mt-5">
        <h2 class="mb-4">RSI í…ŒìŠ¤íŠ¸ ì¡°íšŒ</h2>
        <button class="btn btn-success" onclick="getRsiData()">ì‹¤ì‹œê°„ RSI ì¡°íšŒí•˜ê¸°</button>
        <div id="output-rsi" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
    </div>
    <br/><br/>
    <div class="container mt-5">
        <h2 class="mb-4">ì´ë™í‰ê· ì„  í…ŒìŠ¤íŠ¸ ì¡°íšŒ</h2>
        <button class="btn btn-success" onclick="getMovingAverage()">ì´ë™í‰ê· ì„  ì¡°íšŒí•˜ê¸°</button>
        <div id="output-moving-average" class="card p-3 mt-3 shadow-sm" style="display: none;"></div>
    </div>

    <button onclick="checkGoldenCross()">ê³¨ë“ í¬ë¡œìŠ¤ íƒìƒ‰</button>

    <div class="container mt-5">
        <h2 class="mb-4">ì°¨íŠ¸</h2>
        <button class="btn btn-success mb-3" onclick="loadChart()">ì°¨íŠ¸ ë¡œë“œ</button>
        <canvas id="stockChart" height="200"></canvas>
    </div>

    <!-- ë§¤ìˆ˜ ëª¨ë‹¬ -->
    <div class="modal fade" id="buyModal" tabindex="-1">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title">ğŸ“¥ ì¢…ëª© ë§¤ìˆ˜</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            <p id="buyStockInfo"></p>
            <input type="hidden" id="buyCode">
            <div class="mb-3">
                <label>ë§¤ìˆ˜ ê°€ê²©</label>
                <input type="number" id="buyPrice" class="form-control">
            </div>
            <div class="mb-3">
                <label>ë§¤ìˆ˜ ìˆ˜ëŸ‰</label>
                <input type="number" id="buyQty" class="form-control">
            </div>
            </div>
            <div class="modal-footer">
            <button class="btn btn-primary" onclick="submitBuyOrder()">ë§¤ìˆ˜</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
        </div>
    </div>
      
    <!-- ë§¤ë„ ëª¨ë‹¬ -->
    <div class="modal fade" id="sellModal" tabindex="-1">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title">ğŸ“¤ ì¢…ëª© ë§¤ë„</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            <p id="sellStockInfo"></p>
            <input type="hidden" id="sellCode">
            <div class="mb-3">
                <label>ë§¤ë„ ê°€ê²©</label>
                <input type="number" id="sellPrice" class="form-control">
            </div>
            <div class="mb-3">
                <label>ë§¤ë„ ìˆ˜ëŸ‰</label>
                <input type="number" id="sellQty" class="form-control">
            </div>
            </div>
            <div class="modal-footer">
            <button class="btn btn-danger" onclick="submitSellOrder()">ë§¤ë„</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
        </div>
    </div>

    <script>
        let myHoldings = [];

        async function fetchAccount() {
            const el = document.getElementById("output");
            const el2 = document.getElementById("output-available-cash");

            el.innerHTML = `<p class="text-muted">âŒ› ê³„ì¢Œ ì”ê³  ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
            el2.innerHTML = `<p class="text-muted">âŒ› ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
            el.style.display = "block";
            el2.style.display = "block";

            try {
                // 1. ê³„ì¢Œ ì”ê³  ì¡°íšŒ
                const res1 = await fetch("/api/account");
                const data1 = await res1.json();

                if (data1.error) {
                    el.innerHTML = `<p class="text-danger">âŒ ${data1.error}</p>`;
                } else {
                    const totalInvestment = Number(data1.total_investment.replace(/,/g, ""));
                    const totalValuation = Number(data1.total_valuation.replace(/,/g, ""));
                    const profit = totalValuation - totalInvestment;

                    const profitClass = profit >= 0 ? "text-danger" : "text-primary";
                    const profitRate = totalInvestment !== 0 ? (profit / totalInvestment) * 100 : 0;

                    el.innerHTML = `
                        <ul class="list-group">
                            <li class="list-group-item"><strong>ì´ íˆ¬ìê¸ˆì•¡:</strong> ${totalInvestment.toLocaleString()} ì›</li>
                            <li class="list-group-item"><strong>ì´ í‰ê°€ê¸ˆì•¡:</strong> ${totalValuation.toLocaleString()} ì›</li>
                            <li class="list-group-item ${profitClass}">
                                <strong>ğŸ“ˆ ì†ìµ:</strong> ${profit.toLocaleString()} ì›
                                <small class="ms-2">(${profitRate.toFixed(2)}%)</small>
                            </li>
                        </ul>`;
                }

                // 2. ì£¼ë¬¸ ê°€ëŠ¥ ê¸ˆì•¡ ì¡°íšŒ (ìˆœì°¨ì )
                const res2 = await fetch("/api/available_cash");
                const data2 = await res2.json();

                if (data2.error) {
                    el2.innerHTML = `<p class="text-danger">âŒ ${data2.error}</p>`;
                } else {
                    const cash = Number(data2.available_cash.replace(/,/g, ""));
                    el2.innerHTML = `
                        <ul class="list-group">
                            <li class="list-group-item"><strong>ğŸ’° ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡:</strong> ${cash.toLocaleString()} ì›</li>
                        </ul>`;
                }

            } catch (err) {
                el.innerHTML = `<p class="text-danger">âŒ ${err}</p>`;
            }
        }
        
        async function fetchHoldings() {
            const el = document.getElementById("output-holdings");
            el.innerHTML = `<p class="text-muted">âŒ› ë³´ìœ  ì¢…ëª© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
            el.style.display = "block";

            try {
                const res = await fetch("/api/holdings");
                const data = await res.json();

                myHoldings = []; // ì „ì—­ ë°°ì—´ ì´ˆê¸°í™”

                if (data.error) {
                    el.innerHTML = `<p class="text-danger">âŒ ${data.error}</p>`;
                    return;
                }

                if (Array.isArray(data) && data.length > 0) {
                    let list = data.map(h => {
                        const tmpCode = h.code.replace("A", "");
                        myHoldings.push(tmpCode); // ë³´ìœ  ì¢…ëª© ì €ì¥

                        const current = Number(h.current_price);
                        const purchase = Number(h.purchase_price);
                        const quantity = Number(h.quantity);
                        const profit = (current - purchase) * quantity;
                        const rate = purchase ? ((current - purchase) / purchase) * 100 : 0;
                        const profitClass = profit >= 0 ? "text-danger" : "text-primary";

                        return `
                            <li class="list-group-item" data-code="${h.code}">
                                <div class="d-flex justify-content-between">
                                    <span><strong>${h.name}</strong> (${h.code})</span>
                                    <span>${current.toLocaleString()} ì›</span>
                                </div>
                                <div class="d-flex justify-content-between ms-3 mt-1">
                                    <small>- ${purchase.toLocaleString()} ì›</small>
                                    <small>${quantity} ì£¼</small>
                                    <small>${(purchase * quantity).toLocaleString()} ì›</small>
                                    <small class="${profitClass}">${profit.toLocaleString()} ì› (${rate.toFixed(2)}%)</small>
                                </div>
                            </li>`;
                    }).join('');

                    el.innerHTML = `<ul class="list-group">${list}</ul>`;
                } else {
                    el.innerHTML = "<p class='text-muted'>ğŸ“­ ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                }

            } catch (err) {
                el.innerHTML = `<p class="text-danger">âŒ ì˜¤ë¥˜ ë°œìƒ: ${err}</p>`;
            }
        }

        async function fetchUnfilledOrders() {
            const el = document.getElementById("output-unfilledOrders");
            el.innerHTML = `<p class="text-muted">âŒ› ë¯¸ì²´ê²° ì£¼ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>`;
            el.style.display = "block";

            try {
                const res = await fetch("/api/unfilled_orders");
                const data = await res.json();

                if (data.error) {
                    el.innerHTML = `<p class="text-danger">âŒ ${data.error}</p>`;
                    return;
                }

                const orders = data.orders || [];

                if (orders.length === 0) {
                    el.innerHTML = "<p class='text-muted'>ğŸ“­ í˜„ì¬ ë¯¸ì²´ê²°ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                    return;
                }

                let html = `
                    <table class="table table-sm table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ì¢…ëª©ì½”ë“œ</th>
                                <th>ì¢…ëª©ëª…</th>
                                <th>ì£¼ë¬¸ìˆ˜ëŸ‰</th>
                                <th>ì²´ê²°ìˆ˜ëŸ‰</th>
                                <th>ì£¼ë¬¸ê°€ê²©</th>
                                <th>ë‚¨ì€ìˆ˜ëŸ‰</th>
                            </tr>
                        </thead>
                        <tbody>`;

                orders.forEach(order => {
                    const remaining = order.qty - order.filled;
                    html += `
                        <tr>
                            <td>${order.code}</td>
                            <td>${order.name}</td>
                            <td>${order.qty.toLocaleString()} ì£¼</td>
                            <td>${order.filled.toLocaleString()} ì£¼</td>
                            <td>${order.price.toLocaleString()} ì›</td>
                            <td>${remaining.toLocaleString()} ì£¼</td>
                        </tr>`;
                });

                html += `</tbody></table>`;
                el.innerHTML = html;

            } catch (err) {
                el.innerHTML = `<p class="text-danger">âŒ ì˜¤ë¥˜ ë°œìƒ: ${err}</p>`;
            }
        }
    
        async function fetchVolumeLeaders() {
            const el = document.getElementById("output-volume");
            el.innerHTML = "<p>ğŸ“¡ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤...</p>";
            el.style.display = "block";

            try {
                // âœ… ë¨¼ì € holdings ë¡œë”© ì™„ë£Œê¹Œì§€ ê¸°ë‹¤ë¦¼
                await fetchHoldings();

                // âœ… ê·¸ ë‹¤ìŒ volume ë°ì´í„° fetch
                const res = await fetch("/api/volume-leaders");
                const data = await res.json();

                if (data.error) {
                    el.innerHTML = `<p class="text-danger">âŒ ${data.error}</p>`;
                    return;
                }

                let html = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ì¢…ëª©ì½”ë“œ</th>
                                <th>ì¢…ëª©ëª…</th>
                                <th>í˜„ì¬ê°€</th>
                                <th>ê±°ë˜ëŸ‰</th>
                                <th>ê±°ë˜ê¸ˆì•¡</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>`;

                data.stocks.forEach(stock => {
                    const isOwned = myHoldings.includes(stock.code);
                    if (isOwned) {
                        console.log("âœ… ë³´ìœ  ì¢…ëª© ë§¤ì¹­:", stock.code, stock.name);
                    }

                    html += `
                        <tr>
                            <td>${stock.code}</td>
                            <td>${stock.name}</td>
                            <td>${Math.abs(Number(stock.price)).toLocaleString()} ì›</td>
                            <td>${Number(stock.vol).toLocaleString()} ì£¼</td>
                            <td>${Number(stock.amount).toLocaleString()} (ë°±ë§Œ)ì›</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary buy-btn"
                                        data-code="${stock.code}"
                                        data-name="${stock.name}"
                                        data-price="${stock.price}">
                                    êµ¬ë§¤
                                </button>
                                ${isOwned ? `
                                <button class="btn btn-sm btn-outline-danger ms-2 sell-btn"
                                        data-code="${stock.code}"
                                        data-name="${stock.name}"
                                        data-price="${stock.price}">
                                    ë§¤ë„
                                </button>` : ""}
                            </td>
                        </tr>`;
                });

                html += `</tbody></table>`;
                el.innerHTML = html;
            } catch (err) {
                console.error("ğŸ“› fetchVolumeLeaders ì—ëŸ¬:", err);
                el.innerHTML = `<p class="text-danger">âŒ ì˜¤ë¥˜ ë°œìƒ: ${err}</p>`;
            }
        }

        function getRsiData() {
            fetch('/get-rsi-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ key: 'value' })  // í•„ìš” ì—†ìœ¼ë©´ ì´ ë¶€ë¶„ ìƒëµ ê°€ëŠ¥
            })
            .then(response => {
                if (response.status === 204) {
                    console.log("API í˜¸ì¶œ ì„±ê³µ (204 No Content)");
                    return null;  // ë” ì´ìƒ ì²˜ë¦¬í•  ê²Œ ì—†ìŒ
                } else if (response.ok) {
                    return response.json();  // JSON ë³¸ë¬¸ íŒŒì‹±
                } else {
                    console.warn("ì‘ë‹µ ì‹¤íŒ¨ ìƒíƒœì½”ë“œ:", response.status);
                    return null;
                }
            })
            .then(data => {
                if (data) {
                    console.log("ğŸ“Š RSI API ê²°ê³¼:", data);
                }
            })
            .catch(err => {
                console.error("ì—ëŸ¬ ë°œìƒ:", err);
            });
        }

        function getMovingAverage() {
            fetch('/get-moving-average', {
        method: 'POST'
      })
        .then(res => res.json())
        .then(data => {
          const labels = data.map(row => row.date);
          const close = data.map(row => row.close);
          const ma5 = data.map(row => row.ma_5);
          const ma20 = data.map(row => row.ma_20);

          const ctx = document.getElementById('maChart').getContext('2d');
          const chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'ì¢…ê°€',
                  data: close,
                  borderColor: 'blue',
                  tension: 0.1,
                  fill: false
                },
                {
                  label: 'MA(5)',
                  data: ma5,
                  borderColor: 'orange',
                  tension: 0.1,
                  fill: false
                },
                {
                  label: 'MA(20)',
                  data: ma20,
                  borderColor: 'green',
                  tension: 0.1,
                  fill: false
                }
              ]
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  title: {
                    display: true,
                    text: 'ë‚ ì§œ'
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: 'ê°€ê²© (â‚©)'
                  }
                }
              },
              plugins: {
                legend: {
                  position: 'top'
                },
                title: {
                  display: true,
                  text: 'ì‚¼ì„±ì „ì ì£¼ê°€ ë° ì´ë™í‰ê· ì„ '
                },
                zoom: {
                  pan: {
                    enabled: true,
                    mode: 'x',
                    modifierKey: null // âœ… ë§ˆìš°ìŠ¤ë§Œìœ¼ë¡œ ë“œë˜ê·¸ ì´ë™ ê°€ëŠ¥
                  },
                  zoom: {
                    wheel: {
                      enabled: true
                    },
                    pinch: {
                      enabled: true
                    },
                    mode: 'x'
                  }
                }
              }
            }
          });
        });
        }

        function checkGoldenCross() {
            // const codes = ["005930", "000660", "036830", "064760", "052690", "025770"];  // ì˜ˆì‹œ: ì‚¼ì„±ì „ì, SKí•˜ì´ë‹‰ìŠ¤ ...

            fetch('/detect-golden-cross', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: "005490" })
            })
            .then(res => res.json())
            .then(data => {
                console.log("ğŸ” ê³¨ë“ í¬ë¡œìŠ¤ íƒìƒ‰ ê²°ê³¼:", data);
                alert(JSON.stringify(data, null, 2));
            })
            .catch(err => {
                console.error("ì—ëŸ¬ ë°œìƒ:", err);
            });
        }

        let chartInstance;
        async function loadChart() {
            const res = await fetch('/api/chart-data');
            const data = await res.json();
            if (chartInstance) {
                chartInstance.destroy();
            }
            const ctx = document.getElementById('stockChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [
                        { label: 'ì¢…ê°€', data: data.close, borderColor: 'blue', fill: false },
                        { label: '5ì¼ì„ ', data: data.MA5, borderColor: 'orange', fill: false },
                        { label: '20ì¼ì„ ', data: data.MA20, borderColor: 'green', fill: false },
                        { label: '60ì¼ì„ ', data: data.MA60, borderColor: 'red', fill: false },
                        { label: '120ì¼ì„ ', data: data.MA120, borderColor: 'purple', fill: false }
                    ]
                },
                options: {
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
                        }
                    }
                }
            });
        }

        function openBuyModal(code, name, price) {
            document.getElementById("buyStockInfo").innerText = `${code} (${name}) í˜„ì¬ê°€: ${Number(price).toLocaleString()} ì›`;
            document.getElementById("buyCode").value = code;
            document.getElementById("buyPrice").value = price;
            document.getElementById("buyQty").value = "";
            new bootstrap.Modal(document.getElementById("buyModal")).show();
        }

        function openSellModal(code, name, price) {
            document.getElementById("sellStockInfo").innerText = `${code} (${name}) í˜„ì¬ê°€: ${Number(price).toLocaleString()} ì›`;
            document.getElementById("sellCode").value = code;
            document.getElementById("sellPrice").value = price;
            document.getElementById("sellQty").value = "";
            new bootstrap.Modal(document.getElementById("sellModal")).show();
        }

        function submitBuyOrder() {
            const code = document.getElementById("buyCode").value;
            const price = parseInt(document.getElementById("buyPrice").value);
            const qty = parseInt(document.getElementById("buyQty").value);

            fetch("/api/buy", {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ code, price, qty })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message || JSON.stringify(data));
                bootstrap.Modal.getInstance(document.getElementById("buyModal")).hide();
            });
        }

        function submitSellOrder() {
            const code = document.getElementById("sellCode").value;
            const price = parseInt(document.getElementById("sellPrice").value);
            const qty = parseInt(document.getElementById("sellQty").value);

            fetch("/api/sell", {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ code, price, qty })
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message || JSON.stringify(data));
                bootstrap.Modal.getInstance(document.getElementById("sellModal")).hide();
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.addEventListener("click", function (e) {
                const buyBtn = e.target.closest(".buy-btn");
                const sellBtn = e.target.closest(".sell-btn");
                if (buyBtn) {
                    const code = buyBtn.dataset.code;
                    const name = buyBtn.dataset.name;
                    const price = buyBtn.dataset.price;
                    openBuyModal(code, name, price);
                } else if (sellBtn) {
                    const code = sellBtn.dataset.code;
                    const name = sellBtn.dataset.name;
                    const price = sellBtn.dataset.price;
                    openSellModal(code, name, price);
                }
            });
        });
    </script>
</body>
</html>
